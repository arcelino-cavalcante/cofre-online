<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhaeria - Suas Metas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos com Variáveis de CSS para Temas */
        :root {
            --bg-color: #1a1a2e;
            --text-color: #e0e0e0;
            --primary-neon: #f871b5;
            --secondary-neon: #ec4899;
            --accent-color: #f871b5;
            --accent-text: #1a1a2e;
            --accent-bg-light: rgba(236, 72, 153, 0.1);
            --accent-bg-medium: rgba(236, 72, 153, 0.2);
            --text-shadow-style: 0 0 5px var(--primary-neon), 0 0 10px var(--primary-neon), 0 0 20px var(--secondary-neon), 0 0 40px var(--secondary-neon);
            --box-shadow-style: 0 0 10px var(--primary-neon), 0 0 20px var(--secondary-neon) inset;
            --button-text-color: #fce7f3; /* Light pink for high contrast */
            --progress-bg: #374151;
        }

        [data-theme="galaxy"] {
            --bg-color: #0f172a; --text-color: #e2e8f0; --primary-neon: #22d3ee; --secondary-neon: #06b6d4; --accent-color: #06b6d4; --accent-text: #0f172a; --accent-bg-light: rgba(34, 211, 238, 0.1); --accent-bg-medium: rgba(34, 211, 238, 0.2); --button-text-color: #ecfeff; --progress-bg: #1e293b;
        }
        [data-theme="nature"] {
            --bg-color: #14211a; --text-color: #d1fae5; --primary-neon: #34d399; --secondary-neon: #10b981; --accent-color: #10b981; --accent-text: #14211a; --accent-bg-light: rgba(52, 211, 153, 0.1); --accent-bg-medium: rgba(52, 211, 153, 0.2); --button-text-color: #f0fdf4; --progress-bg: #115e59;
        }
        [data-theme="magic"] {
            --bg-color: #2c1d3d; --text-color: #e9d5ff; --primary-neon: #c084fc; --secondary-neon: #a855f7; --accent-color: #a855f7; --accent-text: #2c1d3d; --accent-bg-light: rgba(192, 132, 252, 0.1); --accent-bg-medium: rgba(192, 132, 252, 0.2); --button-text-color: #faf5ff; --progress-bg: #3b0764;
        }
        [data-theme="green"], [data-theme="blue"], [data-theme="white"], [data-theme="all-black"], [data-theme="gray"] {
            --text-shadow-style: none;
            --box-shadow-style: none;
        }
        [data-theme="green"] { --bg-color: #f0fdf4; --text-color: #064e3b; --primary-neon: #15803d; --secondary-neon: #166534; --accent-color: #16a34a; --accent-text: #ffffff; --accent-bg-light: #dcfce7; --accent-bg-medium: #bbf7d0; --button-text-color: #065f46; --progress-bg: #dcfce7; }
        [data-theme="blue"] { --bg-color: #eff6ff; --text-color: #1e3a8a; --primary-neon: #2563eb; --secondary-neon: #1d4ed8; --accent-color: #2563eb; --accent-text: #ffffff; --accent-bg-light: #dbeafe; --accent-bg-medium: #bfdbfe; --button-text-color: #1e40af; --progress-bg: #dbeafe; }
        [data-theme="white"] { --bg-color: #ffffff; --text-color: #111827; --primary-neon: #1f2937; --secondary-neon: #111827; --accent-color: #374151; --accent-text: #ffffff; --accent-bg-light: #f3f4f6; --accent-bg-medium: #e5e7eb; --button-text-color: #111827; --progress-bg: #e5e7eb; }
        [data-theme="all-black"] { --bg-color: #000000; --text-color: #e5e7eb; --primary-neon: #f9fafb; --secondary-neon: #e5e7eb; --accent-color: #374151; --accent-text: #ffffff; --accent-bg-light: #1f2937; --accent-bg-medium: #374151; --button-text-color: #f9fafb; --progress-bg: #1f2937; }
        [data-theme="gray"] { --bg-color: #f3f4f6; --text-color: #111827; --primary-neon: #1f2937; --secondary-neon: #111827; --accent-color: #374151; --accent-text: #ffffff; --accent-bg-light: #e5e7eb; --accent-bg-medium: #d1d5db; --button-text-color: #111827; --progress-bg: #d1d5db; }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease;
        }
        body.login-theme { background-color: #e0f2fe; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .neon-text {
            color: var(--primary-neon);
            text-shadow: var(--text-shadow-style);
        }
        .neon-box {
            border: 2px solid var(--primary-neon);
            box-shadow: var(--box-shadow-style);
            transition: all 0.3s ease-in-out;
        }
        .neon-button {
             background-color: var(--accent-bg-medium);
             border: 1px solid var(--secondary-neon);
             color: var(--button-text-color);
             transition: all 0.3s ease;
        }
        .neon-button:hover {
            background-color: var(--secondary-neon);
            color: var(--accent-text);
            box-shadow: 0 0 15px var(--primary-neon);
        }
        .login-theme #login-screen .neon-box { background-color: white; border-color: #7dd3fc; box-shadow: none; }
        .login-theme #login-screen .neon-text { color: #0ea5e9; text-shadow: none; }
        .login-theme #login-screen .text-accent { color: #0369a1; }
        .login-theme #login-screen input { background-color: #f0f9ff; border-color: #bae6fd; color: #0c4a6e; }
        .login-theme #login-screen .neon-button { background-color: #0ea5e9; border-color: #0ea5e9; color: white; }
        .login-theme #login-screen .neon-button:hover { background-color: #0284c7; }

        .deposit-item { background-color: var(--accent-bg-light); border: 1px solid var(--secondary-neon); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .deposit-item.marked { background-color: var(--accent-color); color: var(--accent-text); transform: scale(1.05); box-shadow: 0 0 15px var(--primary-neon); }
        .deposit-item.marked .flower-icon { opacity: 1; transform: scale(1) rotate(360deg); }
        .progress-bar-track { background-color: var(--progress-bg); }
        .progress-bar-inner { background: linear-gradient(90deg, var(--primary-neon), var(--secondary-neon)); box-shadow: 0 0 5px var(--primary-neon), 0 0 10px var(--secondary-neon); transition: width 0.5s ease-in-out; }
        .flower-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); color: white; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .text-accent { color: var(--primary-neon); }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"] { background-color: var(--accent-bg-light); border: 1px solid var(--secondary-neon); color: var(--text-color); }
        input:focus { outline: none; box-shadow: 0 0 10px var(--primary-neon); }
        .theme-selector button { width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; transition: transform 0.2s; }
        .theme-selector button:hover { transform: scale(1.1); }
        .theme-selector button.active { transform: scale(1.2); box-shadow: 0 0 10px white; }
        #loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-neon); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .achievement-item { transition: all 0.3s ease; }
        .achievement-item.locked { filter: grayscale(1); opacity: 0.6; }
        .achievement-item.locked .text-4xl { filter: blur(2px); }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900/80 hidden">
        <div id="loader"></div>
        <p id="loading-text" class="mt-4 text-accent">Carregando...</p>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="max-w-md mx-auto">
         <header class="text-center mb-8">
            <h1 class="font-pacifico text-5xl md:text-6xl neon-text">Minhaeria</h1>
            <p class="text-accent text-lg mt-2">Seu cofre de sonhos</p>
        </header>
        <div class="neon-box bg-gray-900/50 rounded-2xl p-8 space-y-6">
            <div>
                <label for="email-input" class="block mb-2 font-bold text-accent">Email:</label>
                <input type="email" id="email-input" placeholder="seu@email.com" class="w-full p-3 rounded-lg">
            </div>
            <div>
                <label for="password-input" class="block mb-2 font-bold text-accent">Senha:</label>
                <input type="password" id="password-input" placeholder="••••••••" class="w-full p-3 rounded-lg">
            </div>
            <p id="login-error" class="text-red-400 text-center h-4"></p>
            <button id="login-btn" class="w-full neon-button font-bold text-lg py-3 px-6 rounded-lg mt-4">Entrar</button>
        </div>
    </div>

    <!-- Tela de Configuração da Meta -->
    <div id="setup-screen" class="max-w-2xl mx-auto hidden">
        <header class="text-center mb-8">
            <h1 id="setup-title" class="font-pacifico text-4xl md:text-5xl neon-text">Crie sua Meta</h1>
            <p class="text-accent text-lg mt-2">Vamos começar um novo desafio!</p>
        </header>
        <div class="neon-box bg-gray-900/50 rounded-2xl p-6 space-y-6">
            <div>
                <label for="owner-name-input" class="block mb-2 font-bold text-accent">Seu Nome (Proprietário):</label>
                <input type="text" id="owner-name-input" placeholder="Ex: Alice Vasconcelos" class="w-full p-2 rounded-lg">
            </div>
            <div>
                <label for="goal-name-input" class="block mb-2 font-bold text-accent">Nome da Meta:</label>
                <input type="text" id="goal-name-input" placeholder="Ex: Viagem para a praia" class="w-full p-2 rounded-lg">
            </div>
            <div>
                <label class="block mb-2 font-bold text-accent">Valores para Depositar:</label>
                <div id="parcels-container" class="space-y-3"></div>
                <button id="add-parcel-btn" class="neon-button font-semibold py-2 px-4 rounded-lg mt-4 text-sm">+ Adicionar tipo de depósito</button>
            </div>
            <div class="text-center pt-4">
                <p class="text-accent">Total do Desafio:</p>
                <p id="calculated-total" class="text-3xl font-bold neon-text">R$ 0,00</p>
            </div>
            <button id="start-challenge-btn" class="w-full neon-button font-bold text-lg py-3 px-6 rounded-lg mt-4">Salvar Meta</button>
            <button id="logout-btn-setup" class="w-full text-accent font-semibold py-2 mt-2">Sair</button>
        </div>
        <footer class="text-center mt-8">
            <div id="theme-selector-setup" class="theme-selector flex justify-center items-center gap-4"></div>
        </footer>
    </div>

    <!-- Tela Principal do Desafio -->
    <div id="app-screen" class="max-w-4xl mx-auto hidden">
        <header class="text-center mb-8">
            <h1 id="goal-title" class="font-pacifico text-4xl md:text-5xl neon-text"></h1>
            <p id="goal-owner" class="text-accent text-lg mt-2"></p>
        </header>
        <section id="progress-panel" class="neon-box bg-gray-900/50 rounded-2xl p-6 mb-8 text-center">
            <h2 class="text-xl font-bold text-accent">Meu Progresso</h2>
            <p id="total-saved" class="text-4xl font-bold neon-text my-3">R$ 0,00</p>
            <div class="w-full rounded-full h-4 progress-bar-track"><div id="progress-bar" class="progress-bar-inner h-4 rounded-full" style="width: 0%"></div></div>
            <p id="progress-text" class="text-accent mt-2"></p>
        </section>
        <main id="deposits-grid" class="grid grid-cols-5 sm:grid-cols-10 gap-2 md:gap-3"></main>
        <footer class="text-center mt-8">
            <div class="mb-6 flex flex-wrap justify-center items-center gap-4">
                <button id="achievements-btn" class="neon-button font-bold py-2 px-6 rounded-lg">🏆 Conquistas</button>
                <button id="reports-btn" class="neon-button font-bold py-2 px-6 rounded-lg">Ver Gráficos</button>
                <button id="reset-button" class="neon-button font-bold py-2 px-6 rounded-lg">Reiniciar Progresso</button>
                <button id="new-goal-button" class="neon-button font-bold py-2 px-6 rounded-lg">Apagar e Criar Nova</button>
                <button id="logout-btn" class="bg-red-500/50 border border-red-500 text-red-300 font-bold py-2 px-6 rounded-lg hover:bg-red-500 hover:text-white">Sair</button>
            </div>
            <div id="theme-selector-app" class="theme-selector flex justify-center items-center gap-4"></div>
        </footer>
    </div>

    <!-- Modais -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="neon-box bg-gray-800 rounded-2xl p-8 max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-2xl font-bold neon-text mb-4"></h3>
            <p id="modal-text" class="text-accent mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Sim</button>
                <button id="cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="motivation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="neon-box bg-gray-800 rounded-2xl p-8 max-w-sm w-full text-center">
            <h3 id="motivation-title" class="text-2xl font-bold neon-text mb-4"></h3>
            <p id="motivation-text" class="text-accent mb-6"></p>
            <button id="motivation-close-btn" class="neon-button font-bold py-2 px-6 rounded-lg">Continuar!</button>
        </div>
    </div>
    <div id="reports-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="neon-box bg-gray-800 rounded-2xl p-8 max-w-3xl w-full text-center">
            <h3 class="text-2xl font-bold neon-text mb-6">Relatórios de Progresso</h3>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h4 class="text-lg font-semibold text-accent mb-4">Depósitos por Valor</h4>
                    <canvas id="pie-chart"></canvas>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-accent mb-4">Evolução do Saldo</h4>
                    <canvas id="line-chart"></canvas>
                </div>
            </div>
            <button id="reports-close-btn" class="neon-button font-bold py-2 px-6 rounded-lg mt-8">Fechar</button>
        </div>
    </div>
    <div id="achievements-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="neon-box bg-gray-800 rounded-2xl p-8 max-w-4xl w-full text-center">
            <h3 class="text-2xl font-bold neon-text mb-6">🏆 Quadro de Conquistas</h3>
            <div id="achievements-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto p-2">
                <!-- Conquistas serão inseridas aqui -->
            </div>
            <button id="achievements-close-btn" class="neon-button font-bold py-2 px-6 rounded-lg mt-8">Fechar</button>
        </div>
    </div>
    <div id="achievement-unlocked-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="neon-box bg-gray-800 rounded-2xl p-8 max-w-sm w-full text-center transform transition-transform scale-50 opacity-0">
            <h3 class="text-2xl font-bold neon-text mb-2">Conquista Desbloqueada!</h3>
            <p id="unlocked-achievement-icon" class="text-7xl my-4"></p>
            <h4 id="unlocked-achievement-name" class="text-xl font-bold text-accent"></h4>
            <p id="unlocked-achievement-desc" class="text-sm text-gray-300 mb-6"></p>
            <button id="unlocked-achievement-close-btn" class="neon-button font-bold py-2 px-6 rounded-lg">Legal!</button>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyAN4BkMo5D36jlIZnaK6e6S4PZFoLWz7yM",
          authDomain: "cofre-online.firebaseapp.com",
          projectId: "cofre-online",
          storageBucket: "cofre-online.appspot.com", 
          messagingSenderId: "424084029673",
          appId: "1:424084029673:web:b05a4630d400c96a6bb078"
        };
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DEFINIÇÕES DE JOGO ---
        const THEMES = {
            'neon-pink': { name: 'Rosa Neon', color: '#f871b5' }, 'galaxy': { name: 'Azul Galáxia', color: '#22d3ee' }, 'nature': { name: 'Verde Natureza', color: '#34d399' }, 'magic': { name: 'Roxo Mágico', color: '#c084fc' }, 'blue': { name: 'Azul Clássico', color: '#3b82f6' }, 'green': { name: 'Verde Clássico', color: '#22c55e' }, 'gray': { name: 'Cinza', color: '#6b7280' }, 'white': { name: 'Branco', color: '#e5e7eb' }, 'all-black': { name: 'All Black', color: '#1f2937' }
        };
        const MOTIVATIONAL_MESSAGES = {
            5: "É isso aí! O primeiro passo é o mais importante. Continue assim!", 10: "Incrível! Você já alcançou 10% da sua meta. Cada depósito conta!", 15: "Você está pegando o ritmo! Continue focada e verá os resultados.", 20: "Um quinto do caminho já foi! Sua dedicação está fazendo a diferença.", 25: "Parabéns! Você chegou a 1/4 da sua meta. Você é imparável!", 30: "Olha só esse progresso! Você está cada vez mais perto.", 35: "Continue brilhando! Sua disciplina é sua maior aliada.", 40: "Uau! Quase na metade. O resultado final será muito gratificante.", 45: "Falta muito pouco para a metade! Você está mandando muito bem.", 50: "METADE DO CAMINHO! 🎉 Você é incrível! Comemore essa grande conquista.", 55: "A maior parte já foi! Agora é manter o foco na reta final.", 60: "Excelente! Você está construindo seu sonho, depósito por depósito.", 65: "Sua determinação é inspiradora. Continue com essa energia!", 70: "70% e contando! O cheirinho de vitória está no ar.", 75: "Parabéns! 3/4 da meta concluídos. Falta pouco, não desista agora!", 80: "Você está na reta final! Visualize seu objetivo se tornando realidade.", 85: "Quase lá! Cada centavo te deixa mais perto do seu sonho.", 90: "SÓ FALTAM 10%! Você consegue, a linha de chegada está logo ali!", 95: "Está por um fio! O último esforço é o que te levará à glória.", 100: "VOCÊ CONSEGUIU! PARABÉNS! 🎉 Celebre muito! Você realizou sua meta e provou que é capaz de tudo!"
        };
        const ACHIEVEMENTS = {
            'firstDeposit': { name: 'Pé-quente', desc: 'Fazer o primeiro depósito.', icon: '🏆' },
            'first10': { name: 'De grão em grão...', desc: 'Fazer 10 depósitos.', icon: '🌱'},
            'deposit50': { name: 'Mão de Vaca', desc: 'Fazer um total de 50 depósitos.', icon: '🐮' },
            'deposit100': { name: 'Maratonista', desc: 'Fazer um total de 100 depósitos.', icon: '🏃‍♀️' },
            'save100': { name: 'Economista', desc: 'Acumular R$ 100 pela primeira vez.', icon: '💰' },
            'save500': { name: 'Investidor', desc: 'Acumular R$ 500 pela primeira vez.', icon: '💎' },
            'save1000': { name: 'Mestre Poupador', desc: 'Acumular R$ 1.000 pela primeira vez.', icon: '🧙' },
            'depositStreak7': { name: 'Em Chamas!', desc: 'Fazer depósitos por 7 dias seguidos.', icon: '🔥' },
            'goalCompleted': { name: 'Rei/Rainha da Economia', desc: 'Completar a primeira meta.', icon: '👑' },
            'bigGoal': { name: 'Visionário', desc: 'Criar uma meta de mais de R$ 2.000.', icon: '🔭' },
            'allThemes': { name: 'Colecionador de Cores', desc: 'Experimentar todos os temas de cores.', icon: '🎨' },
            'newBeginning': { name: 'Recomeço', desc: 'Criar uma nova meta após completar uma.', icon: '🌅' }
        };

        // --- ELEMENTOS DO DOM ---
        const loadingScreen = document.getElementById('loading-screen'), loadingText = document.getElementById('loading-text');
        const loginScreen = document.getElementById('login-screen'), emailInput = document.getElementById('email-input'), passwordInput = document.getElementById('password-input'), loginBtn = document.getElementById('login-btn'), loginError = document.getElementById('login-error');
        const setupScreen = document.getElementById('setup-screen'), setupTitle = document.getElementById('setup-title'), appScreen = document.getElementById('app-screen');
        const ownerNameInput = document.getElementById('owner-name-input'), goalNameInput = document.getElementById('goal-name-input'), parcelsContainer = document.getElementById('parcels-container'), addParcelBtn = document.getElementById('add-parcel-btn'), calculatedTotalEl = document.getElementById('calculated-total'), startChallengeBtn = document.getElementById('start-challenge-btn'), logoutBtnSetup = document.getElementById('logout-btn-setup');
        const goalTitle = document.getElementById('goal-title'), goalOwner = document.getElementById('goal-owner'), totalSavedEl = document.getElementById('total-saved'), progressBar = document.getElementById('progress-bar'), progressText = document.getElementById('progress-text'), depositsGrid = document.getElementById('deposits-grid');
        const resetButton = document.getElementById('reset-button'), newGoalButton = document.getElementById('new-goal-button'), logoutBtn = document.getElementById('logout-btn'), reportsBtn = document.getElementById('reports-btn'), achievementsBtn = document.getElementById('achievements-btn');
        const modal = document.getElementById('confirmation-modal'), modalTitle = document.getElementById('modal-title'), modalText = document.getElementById('modal-text'), confirmBtn = document.getElementById('confirm-btn'), cancelBtn = document.getElementById('cancel-btn');
        const motivationModal = document.getElementById('motivation-modal'), motivationTitle = document.getElementById('motivation-title'), motivationText = document.getElementById('motivation-text'), motivationCloseBtn = document.getElementById('motivation-close-btn');
        const reportsModal = document.getElementById('reports-modal'), reportsCloseBtn = document.getElementById('reports-close-btn');
        const achievementsModal = document.getElementById('achievements-modal'), achievementsGrid = document.getElementById('achievements-grid'), achievementsCloseBtn = document.getElementById('achievements-close-btn');
        const unlockedModal = document.getElementById('achievement-unlocked-modal'), unlockedIcon = document.getElementById('unlocked-achievement-icon'), unlockedName = document.getElementById('unlocked-achievement-name'), unlockedDesc = document.getElementById('unlocked-achievement-desc'), unlockedCloseBtn = document.getElementById('unlocked-achievement-close-btn');
        const themeSelectors = [document.getElementById('theme-selector-setup'), document.getElementById('theme-selector-app')];

        let userData = null, confirmAction = null, audioReady = false, userId = null;
        let pieChart = null, lineChart = null;

        // --- CONFIGURAÇÃO DE ÁUDIO (Tone.js) ---
        const markSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const unmarkSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0 } }).toDestination();
        const milestoneSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
        const achievementSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'fatsawtooth' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.2, release: 0.4 } }).toDestination();
        function playSound(type) {
            if (!audioReady) return;
            if (type === 'mark') markSynth.triggerAttackRelease("C5", "8n");
            else if (type === 'unmark') unmarkSynth.triggerAttackRelease("0.1");
            else if (type === 'milestone') milestoneSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n", Tone.now());
            else if (type === 'achievement') achievementSynth.triggerAttackRelease(["C4", "G4", "C5", "E5"], "8n", Tone.now());
        }
        function initAudio() { if (!audioReady) { Tone.start(); audioReady = true; } }
        
        // --- FUNÇÃO AUXILIAR ---
        function calculateTotalSaved() {
            if (!userData || !Array.isArray(userData.markedIndices) || !Array.isArray(userData.deposits)) return 0;
            return userData.markedIndices.reduce((sum, i) => sum + parseFloat(userData.deposits[i] || 0), 0);
        }

        // --- FUNÇÕES DE TEMA ---
        function applyTheme(themeKey) {
            document.body.dataset.theme = themeKey;
            document.body.classList.remove('login-theme');
            themeSelectors.forEach(s => s.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.theme === themeKey)));
        }
        async function saveAndApplyTheme(themeKey) {
            applyTheme(themeKey);
            if (userId) {
                userData.theme = themeKey;
                if (!userData.themesUsed) userData.themesUsed = [];
                if (!userData.themesUsed.includes(themeKey)) {
                    userData.themesUsed.push(themeKey);
                }
                await saveUserData();
                await checkAllAchievements();
            }
        }
        function renderThemeSelectors() {
            themeSelectors.forEach(selector => {
                selector.innerHTML = '';
                for (const [key, theme] of Object.entries(THEMES)) {
                    const button = document.createElement('button');
                    button.dataset.theme = key; button.style.backgroundColor = theme.color; button.title = theme.name;
                    button.addEventListener('click', () => saveAndApplyTheme(key));
                    selector.appendChild(button);
                }
            });
        }

        // --- FUNÇÕES DE DADOS (FIRESTORE) ---
        async function saveUserData() {
            if (!userId || !userData) return;
            await setDoc(doc(db, "users", userId), userData);
        }
        async function loadUserData() {
            if (!userId) return;
            const docSnap = await getDoc(doc(db, "users", userId));
            userData = docSnap.exists() ? docSnap.data() : { unlockedAchievements: [], themesUsed: [] };
        }
        
        // --- FUNÇÕES DE CONFIGURAÇÃO (SETUP) ---
        function addParcelRow() {
            const parcelDiv = document.createElement('div');
            parcelDiv.className = 'flex items-center gap-2 parcel-row';
            parcelDiv.innerHTML = `<input type="number" class="w-1/3 p-2 rounded-lg parcel-quantity" placeholder="Qtd."><span class="text-accent">depósitos de R$</span><input type="number" class="w-1/3 p-2 rounded-lg parcel-value" placeholder="Valor"><button class="text-red-400 hover:text-red-600 remove-parcel-btn">✖</button>`;
            parcelsContainer.appendChild(parcelDiv);
            parcelDiv.querySelector('.remove-parcel-btn').addEventListener('click', () => { parcelDiv.remove(); updateCalculatedTotal(); });
            parcelDiv.querySelectorAll('input').forEach(input => input.addEventListener('input', updateCalculatedTotal));
        }
        function updateCalculatedTotal() {
            let total = 0;
            document.querySelectorAll('.parcel-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.parcel-quantity').value) || 0;
                const value = parseFloat(row.querySelector('.parcel-value').value) || 0;
                total += quantity * value;
            });
            calculatedTotalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }
        async function startNewChallenge() {
            const ownerName = ownerNameInput.value.trim();
            const goalName = goalNameInput.value.trim();
            if (!ownerName) { alert('Por favor, insira o nome do proprietário.'); return; }
            if (!goalName) { alert('Por favor, dê um nome para a sua meta.'); return; }
            const deposits = [];
            let total = 0;
            document.querySelectorAll('.parcel-row').forEach(row => {
                const quantity = parseInt(row.querySelector('.parcel-quantity').value), value = parseFloat(row.querySelector('.parcel-value').value);
                if (quantity > 0 && value > 0) { for (let i = 0; i < quantity; i++) deposits.push(value); total += quantity * value; }
            });
            if (deposits.length === 0) { alert('Por favor, adicione pelo menos um tipo de depósito válido.'); return; }
            
            if (userData.unlockedAchievements.includes('goalCompleted')) {
                await unlockAchievement('newBeginning');
            }

            userData = {
                ...userData,
                ownerName: ownerName,
                name: goalName,
                total: total,
                deposits: deposits,
                markedIndices: [],
                lastMilestoneAchieved: 0,
                depositHistory: [],
                depositStreak: { current: 0, lastDepositDate: null }
            };
            
            if (total > 2000) {
                await unlockAchievement('bigGoal');
            }

            loadingScreen.classList.remove('hidden');
            await saveUserData();
            await initializeAppUI();
        }
        
        // --- FUNÇÕES DOS GRÁFICOS ---
        function prepareChartData() {
            const depositCounts = {};
            userData.markedIndices.forEach(index => {
                const value = userData.deposits[index];
                depositCounts[value] = (depositCounts[value] || 0) + 1;
            });
            const pieLabels = Object.keys(depositCounts).map(v => `R$ ${v}`);
            const pieData = Object.values(depositCounts);
            const history = (userData.depositHistory || []).sort((a, b) => a.timestamp - b.timestamp);
            let cumulativeAmount = 0;
            const lineData = history.reduce((acc, record) => {
                cumulativeAmount += record.amount;
                const date = new Date(record.timestamp).toLocaleDateString('pt-BR');
                if (!acc.find(item => item.x === date)) {
                     acc.push({ x: date, y: cumulativeAmount });
                } else {
                    acc[acc.length - 1].y = cumulativeAmount;
                }
                return acc;
            }, []);
            return { pieLabels, pieData, lineData };
        }
        function renderCharts() {
            const { pieLabels, pieData, lineData } = prepareChartData();
            const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-neon').trim();
            const pieCtx = document.getElementById('pie-chart').getContext('2d');
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: ['#f871b5', '#22d3ee', '#34d399', '#c084fc', '#f97316', '#eab308'], borderColor: 'var(--bg-color)' }] },
                options: { responsive: true, plugins: { legend: { labels: { color: 'white' } } } }
            });
            const lineCtx = document.getElementById('line-chart').getContext('2d');
            if (lineChart) lineChart.destroy();
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: { datasets: [{ label: 'Saldo Acumulado', data: lineData, borderColor: accentColor, backgroundColor: accentColor + '33', fill: true, tension: 0.1 }] },
                options: { responsive: true, scales: { x: { ticks: { color: 'white' }, grid: { color: '#ffffff20' } }, y: { ticks: { color: 'white' }, grid: { color: '#ffffff20' } } }, plugins: { legend: { labels: { color: 'white' } } } }
            });
        }

        // --- FUNÇÕES DE CONQUISTAS ---
        function showAchievementUnlockedModal(achievementId) {
            const achievement = ACHIEVEMENTS[achievementId];
            if (!achievement) return;
            unlockedIcon.textContent = achievement.icon;
            unlockedName.textContent = achievement.name;
            unlockedDesc.textContent = achievement.desc;
            unlockedModal.classList.remove('hidden');
            setTimeout(() => {
                unlockedModal.firstElementChild.classList.remove('scale-50', 'opacity-0');
                unlockedModal.firstElementChild.classList.add('scale-100', 'opacity-100');
            }, 10);
            playSound('achievement');
        }
        async function unlockAchievement(achievementId) {
            if (userData && userData.unlockedAchievements && !userData.unlockedAchievements.includes(achievementId)) {
                userData.unlockedAchievements.push(achievementId);
                await saveUserData();
                showAchievementUnlockedModal(achievementId);
            }
        }
        async function checkAllAchievements() {
            if (!userData || !userData.deposits) return;
            const totalSaved = calculateTotalSaved();
            const totalDeposits = (userData.depositHistory || []).length;
            
            if (totalDeposits > 0) await unlockAchievement('firstDeposit');
            if (totalDeposits >= 10) await unlockAchievement('first10');
            if (totalDeposits >= 50) await unlockAchievement('deposit50');
            if (totalDeposits >= 100) await unlockAchievement('deposit100');
            if (totalSaved >= 100) await unlockAchievement('save100');
            if (totalSaved >= 500) await unlockAchievement('save500');
            if (totalSaved >= 1000) await unlockAchievement('save1000');
            if (totalSaved >= userData.total) await unlockAchievement('goalCompleted');
            if ((userData.themesUsed || []).length >= Object.keys(THEMES).length) await unlockAchievement('allThemes');
        }
        function renderAchievements() {
            achievementsGrid.innerHTML = '';
            for (const id in ACHIEVEMENTS) {
                const achievement = ACHIEVEMENTS[id];
                const isUnlocked = userData.unlockedAchievements.includes(id);
                const item = document.createElement('div');
                item.className = `achievement-item neon-box p-4 rounded-lg flex flex-col items-center justify-center ${isUnlocked ? '' : 'locked'}`;
                item.innerHTML = `
                    <p class="text-4xl mb-2">${isUnlocked ? achievement.icon : '❓'}</p>
                    <h4 class="font-bold text-accent">${achievement.name}</h4>
                    <p class="text-xs text-gray-300">${achievement.desc}</p>
                `;
                achievementsGrid.appendChild(item);
            }
        }

        // --- FUNÇÕES PRINCIPAIS DO APP ---
        function renderGrid() {
            depositsGrid.innerHTML = '';
            const deposits = Array.isArray(userData.deposits) ? userData.deposits : [];
            const itemsToRender = deposits.map((value, index) => ({ value, originalIndex: index }))
                                          .sort((a, b) => a.value - b.value);

            itemsToRender.forEach(({ value, originalIndex }) => {
                const item = document.createElement('button');
                item.className = 'deposit-item h-12 w-full rounded-lg font-bold text-lg flex items-center justify-center';
                item.dataset.originalIndex = originalIndex;
                item.dataset.value = value;
                const valueSpan = document.createElement('span'); valueSpan.textContent = value.toLocaleString('pt-BR');
                const flowerIcon = document.createElement('span'); flowerIcon.className = 'flower-icon';
                flowerIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256"><path fill="currentColor" d="M224 128a96 96 0 1 1-96-96a96 96 0 0 1 96 96m-32 0a64 64 0 0 0-57.6-63.54a64.3 64.3 0 0 0-12.8 0A64 64 0 0 0 64 128a64 64 0 0 0 63.54 57.6a64.3 64.3 0 0 0 12.8 0A64 64 0 0 0 192 128m-89.42 41.42a8 8 0 0 0-11.31-11.31L128 121.31l-36.72 36.72a8 8 0 0 0-11.31-11.31L116.69 128l-36.72-36.72a8 8 0 0 0 11.31-11.31L128 116.69l36.72-36.72a8 8 0 0 0 11.31 11.31L139.31 128l36.72 36.72a8 8 0 0 0 0 11.31a8 8 0 0 0-5.65 2.35Z"/></svg>`;
                item.appendChild(valueSpan); item.appendChild(flowerIcon);
                item.addEventListener('click', () => toggleMark(originalIndex));
                depositsGrid.appendChild(item);
            });
        }
        async function toggleMark(originalIndex) {
            const alreadyMarked = userData.markedIndices.includes(originalIndex);
            const value = parseFloat(userData.deposits[originalIndex]);
            if (isNaN(value)) { console.error(`Invalid deposit value at index ${originalIndex}`); return; }
            
            if (!userData.depositHistory) userData.depositHistory = [];
            if (!userData.depositStreak) userData.depositStreak = { current: 0, lastDepositDate: null };

            if (alreadyMarked) {
                userData.markedIndices = userData.markedIndices.filter(i => i !== originalIndex);
                const historyIndex = userData.depositHistory.findLastIndex(h => h.amount === value);
                if(historyIndex > -1) userData.depositHistory.splice(historyIndex, 1);
                playSound('unmark');
            } else {
                userData.markedIndices.push(originalIndex);
                userData.depositHistory.push({ amount: value, timestamp: Date.now() });
                playSound('mark');
                await checkAllAchievements();
                await checkMilestone();
            }
            await saveUserData();
            updateUI();
        }
        async function checkMilestone() {
            const totalSaved = calculateTotalSaved();
            const progressPercentage = userData.total > 0 ? (totalSaved / userData.total) * 100 : 0;
            const lastMilestone = userData.lastMilestoneAchieved || 0;
            let nextMilestone = 0;
            for (let m = 5; m <= 100; m += 5) {
                if (progressPercentage >= m && m > lastMilestone) { nextMilestone = m; }
            }
            if (nextMilestone > lastMilestone) {
                userData.lastMilestoneAchieved = nextMilestone;
                showMotivationModal(`🎉 ${nextMilestone}% Alcançado! 🎉`, MOTIVATIONAL_MESSAGES[nextMilestone]);
                playSound('milestone');
                await saveUserData();
            }
        }
        function updateUI() {
            goalTitle.textContent = userData.name;
            goalOwner.textContent = `de ${userData.ownerName || 'Proprietário'}`;
            document.querySelectorAll('.deposit-item').forEach(item => {
                const originalIndex = parseInt(item.dataset.originalIndex);
                item.classList.toggle('marked', userData.markedIndices.includes(originalIndex));
            });
            const totalSaved = calculateTotalSaved();
            const progressPercentage = userData.total > 0 ? (totalSaved / userData.total) * 100 : 0;
            totalSavedEl.textContent = `R$ ${totalSaved.toFixed(2).replace('.', ',')}`;
            progressBar.style.width = `${progressPercentage}%`;
            const goalTotalFormatted = userData.total.toFixed(2).replace('.', ',');
            progressText.textContent = `${Math.floor(progressPercentage)}% completo - Rumo aos R$ ${goalTotalFormatted}!`;
            if (progressPercentage >= 100) {
                progressText.textContent = `Parabéns! Você alcançou sua meta de R$ ${goalTotalFormatted}!`;
                totalSavedEl.classList.add('animate-pulse');
            } else {
                totalSavedEl.classList.remove('animate-pulse');
            }
        }

        // --- FUNÇÕES DE ESTADO ---
        async function resetProgress() { 
            userData.markedIndices = []; 
            userData.lastMilestoneAchieved = 0; 
            userData.depositHistory = [];
            userData.depositStreak = { current: 0, lastDepositDate: null };
            await saveUserData(); 
            updateUI(); 
            hideModal(); 
        }
        async function createNewGoal() { 
            const profileData = {
                ownerName: userData.ownerName,
                theme: userData.theme,
                unlockedAchievements: userData.unlockedAchievements,
                themesUsed: userData.themesUsed,
                depositStreak: userData.depositStreak
            };
            userData = profileData;
            await saveUserData();
            hideModal(); 
            await initializeAppUI();
        }

        // --- FUNÇÕES DO MODAL ---
        function showModal(type) {
            if (type === 'reset') {
                modalTitle.textContent = 'Reiniciar Progresso?'; modalText.textContent = 'Tem certeza? Todo o progresso desta meta será perdido.'; confirmAction = resetProgress;
            } else if (type === 'new') {
                modalTitle.textContent = 'Apagar e Criar Nova?'; modalText.textContent = 'Isso irá apagar a meta atual e todo o seu progresso. Deseja continuar?'; confirmAction = createNewGoal;
            }
            modal.classList.remove('hidden');
        }
        function hideModal() { modal.classList.add('hidden'); confirmAction = null; }
        function showMotivationModal(title, text) {
            motivationTitle.textContent = title; motivationText.textContent = text;
            motivationModal.classList.remove('hidden');
        }
        function hideMotivationModal() { motivationModal.classList.add('hidden'); }
        function showReportsModal() {
            renderCharts();
            reportsModal.classList.remove('hidden');
        }
        function hideReportsModal() { reportsModal.classList.add('hidden'); }
        function showAchievementsModal() {
            renderAchievements();
            achievementsModal.classList.remove('hidden');
        }
        function hideAchievementsModal() { achievementsModal.classList.add('hidden'); }
        function hideUnlockedAchievementModal() {
            unlockedModal.firstElementChild.classList.add('scale-50', 'opacity-0');
            setTimeout(() => unlockedModal.classList.add('hidden'), 300);
        }

        // --- INICIALIZAÇÃO E LÓGICA DE UI ---
        async function initializeAppUI() {
            try {
                loadingText.textContent = 'Carregando seu cofre...';
                loadingScreen.classList.remove('hidden');
                renderThemeSelectors();
                await loadUserData();
                
                if (userData && Array.isArray(userData.deposits)) {
                    if (!userData.unlockedAchievements) userData.unlockedAchievements = [];
                    if (!userData.depositStreak) userData.depositStreak = { current: 0, lastDepositDate: null };
                    if (!userData.themesUsed) userData.themesUsed = [];

                    applyTheme(userData.theme || 'all-black');
                    appScreen.classList.remove('hidden');
                    setupScreen.classList.add('hidden');
                    loginScreen.classList.add('hidden');
                    renderGrid(); 
                    updateUI();
                } else {
                    const savedTheme = userData ? userData.theme : 'all-black';
                    applyTheme(savedTheme);
                    setupScreen.classList.remove('hidden');
                    appScreen.classList.add('hidden');
                    loginScreen.classList.add('hidden');
                    parcelsContainer.innerHTML = ''; addParcelRow();
                    ownerNameInput.value = userData.ownerName || '';
                    goalNameInput.value = ''; updateCalculatedTotal();
                }
            } catch (error) {
                console.error("ERRO FATAL:", error);
                loadingText.textContent = 'Erro de permissão. Fale com o admin.';
                return; 
            }
            loadingScreen.classList.add('hidden');
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.body.addEventListener('click', initAudio, { once: true });
            addParcelBtn.addEventListener('click', addParcelRow);
            startChallengeBtn.addEventListener('click', startNewChallenge);
            reportsBtn.addEventListener('click', showReportsModal);
            reportsCloseBtn.addEventListener('click', hideReportsModal);
            achievementsBtn.addEventListener('click', showAchievementsModal);
            achievementsCloseBtn.addEventListener('click', hideAchievementsModal);
            unlockedCloseBtn.addEventListener('click', hideUnlockedAchievementModal);
            resetButton.addEventListener('click', () => showModal('reset'));
            newGoalButton.addEventListener('click', () => showModal('new'));
            confirmBtn.addEventListener('click', async () => { if (typeof confirmAction === 'function') await confirmAction(); });
            cancelBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
            motivationCloseBtn.addEventListener('click', hideMotivationModal);
            motivationModal.addEventListener('click', (e) => { if (e.target === motivationModal) hideMotivationModal(); });

            loginBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                loginError.textContent = '';
                if (!email || !password) {
                    loginError.textContent = 'Por favor, preencha e-mail e senha.';
                    return;
                }
                loadingText.textContent = 'Entrando...';
                loadingScreen.classList.remove('hidden');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginError.textContent = 'E-mail ou senha inválidos.';
                    loadingScreen.classList.add('hidden');
                }
            });

            const logoutButtons = [logoutBtn, logoutBtnSetup];
            logoutButtons.forEach(btn => {
                if (btn) btn.addEventListener('click', async () => await signOut(auth));
            });
        }

        // --- PONTO DE ENTRADA PRINCIPAL ---
        setupEventListeners();
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                await initializeAppUI();
            } else {
                userId = null;
                userData = null;
                document.body.classList.add('login-theme');
                document.body.removeAttribute('data-theme');
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                setupScreen.classList.add('hidden');
                loadingScreen.classList.add('hidden');
            }
        });
    </script>
</body>

</html>
